<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta name="description" content="Wine Recommendation System - Discover your perfect wine match">
    <meta name="theme-color" content="#ffffff">
    <title>Wine Recommender</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- App Configuration -->
    <script>
        window.APP_CONFIG = {{ config_data|tojson|safe }};
    </script>
    
    <!-- React Development -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <!-- React Router -->
    <script src="https://unpkg.com/react-router-dom@6/umd/react-router-dom.production.min.js"></script>
    
    <!-- React Icons -->
    <script src="https://unpkg.com/react-icons@4.10.1/fa/index.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-roboto">
    <div id="root">
        <!-- Initial loading state -->
        <div class="min-h-screen flex items-center justify-center">
            <div class="max-w-md w-full space-y-8 p-8 bg-white rounded-lg shadow-lg">
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Wine Recommender</h1>
                    <p class="text-gray-600">Your personal wine discovery platform</p>
                </div>
                <div class="mt-8 space-y-6">
                    <div class="text-center">
                        <p class="text-lg text-gray-700">Welcome to Wine Recommender!</p>
                        <p class="mt-2 text-sm text-gray-500">We're setting up your experience.</p>
                        <div class="mt-4">
                            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-purple-500 mx-auto"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- React Application -->
    <script type="text/babel">
        const { BrowserRouter, Routes, Route, Link, useLocation } = ReactRouterDOM;

        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error('Application error:', error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="text-center py-12">
                            <h2 className="text-2xl font-bold text-red-600">Something went wrong</h2>
                            <button 
                                className="mt-4 px-4 py-2 bg-purple-600 text-white rounded"
                                onClick={() => window.location.reload()}
                            >
                                Reload Page
                            </button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // App Component
        function App() {
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState(null);

            React.useEffect(() => {
                // Check if configuration is loaded
                if (!window.APP_CONFIG) {
                    setError('Configuration not found');
                    setIsLoading(false);
                    return;
                }

                // Short delay for loading animation
                const timer = setTimeout(() => {
                    setIsLoading(false);
                }, 500);

                return () => clearTimeout(timer);
            }, []);

            if (error) {
                return (
                    <div className="text-center py-12">
                        <h2 className="text-2xl font-bold text-red-600">Configuration Error</h2>
                        <p className="mt-2 text-gray-600">{error}</p>
                        <button 
                            className="mt-4 px-4 py-2 bg-purple-600 text-white rounded"
                            onClick={() => window.location.reload()}
                        >
                            Retry
                        </button>
                    </div>
                );
            }

            if (isLoading) {
                return null; // Use the HTML loading state
            }

            return (
                <div className="min-h-screen bg-gray-100">
                    <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                        <div className="px-4 py-6 sm:px-0">
                            <Routes>
                                <Route path="/" element={<Home />} />
                                <Route path="/about" element={<About />} />
                                <Route path="/contact" element={<Contact />} />
                                <Route path="/learn" element={<Learn />} />
                                <Route path="*" element={<NotFound />} />
                            </Routes>
                        </div>
                    </main>
                </div>
            );
        }

        // Page Components
        const Home = () => (
            <div className="bg-white shadow rounded-lg p-6">
                <h2 className="text-2xl font-bold mb-4">Welcome to Wine Recommender</h2>
                <p className="text-gray-600">
                    Discover your perfect wine match through our personalized recommendation system.
                </p>
            </div>
        );

        const About = () => (
            <div className="bg-white shadow rounded-lg p-6">
                <h2 className="text-2xl font-bold mb-4">About Us</h2>
                <p className="text-gray-600">
                    Welcome to Wine Recommender, your personal guide to the world of wines.
                </p>
            </div>
        );

        const Contact = () => (
            <div className="bg-white shadow rounded-lg p-6">
                <h2 className="text-2xl font-bold mb-4">Contact Us</h2>
                <p className="text-gray-600">
                    Have questions? We'd love to hear from you.
                </p>
            </div>
        );

        const Learn = () => (
            <div className="bg-white shadow rounded-lg p-6">
                <h2 className="text-2xl font-bold mb-4">Learn About Wine</h2>
                <p className="text-gray-600">
                    Discover the fascinating world of wines.
                </p>
            </div>
        );

        const NotFound = () => (
            <div className="text-center py-12">
                <h2 className="text-2xl font-bold text-gray-900">Page Not Found</h2>
                <p className="mt-2 text-gray-600">The page you're looking for doesn't exist.</p>
                <Link to="/" className="mt-4 inline-block text-purple-600 hover:text-purple-700">
                    Return Home
                </Link>
            </div>
        );

        // Mount React application
        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(
                <ErrorBoundary>
                    <BrowserRouter>
                        <App />
                    </BrowserRouter>
                </ErrorBoundary>
            );
        } catch (error) {
            console.error('Failed to mount React application:', error);
            document.getElementById('root').innerHTML = `
                <div class="text-center py-12">
                    <h2 class="text-2xl font-bold text-red-600">Failed to start application</h2>
                    <p class="mt-2 text-gray-600">Please try refreshing the page</p>
                </div>
            `;
        }
    </script>
</body>
</html>